name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual deployment

env:
  NODE_VERSION: '18.x'
  PNPM_VERSION: '8.x'

jobs:
  # Job 1: Pre-deployment checks
  pre-deploy:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if deployment should proceed
        id: check
        run: |
          # Check commit message for [skip deploy]
          if [[ "${{ github.event.head_commit.message }}" == *"[skip deploy]"* ]]; then
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Deployment skipped by commit message"
          else
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Proceeding with deployment"
          fi

      - name: Verify main branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "‚ö†Ô∏è Not on main branch"
            exit 1
          fi

  # Job 2: Run full test suite
  test-before-deploy:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should-deploy == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test:run

      - name: Type check
        run: pnpm tsc --noEmit

      - name: Build verification
        run: pnpm build

  # Job 3: Security scan before deploy
  security-before-deploy:
    name: Security Check
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should-deploy == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Security audit
        run: |
          pnpm audit --audit-level=critical || {
            echo "‚ùå Critical security vulnerabilities found"
            exit 1
          }

  # Job 4: Deploy to Vercel (or your platform)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deploy, test-before-deploy, security-before-deploy]
    if: needs.pre-deploy.outputs.should-deploy == 'true'
    
    environment:
      name: production
      url: https://your-production-url.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install Vercel CLI
        run: pnpm install -g vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        if: ${{ secrets.VERCEL_TOKEN != '' }}

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        if: ${{ secrets.VERCEL_TOKEN != '' }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
            echo "deployment-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            echo "‚úÖ Deployed to: $DEPLOYMENT_URL"
          else
            echo "‚ö†Ô∏è Vercel token not configured, skipping deployment"
            echo "deployment-url=not-configured" >> $GITHUB_OUTPUT
          fi

      - name: Comment deployment URL on commit
        if: steps.deploy.outputs.deployment-url != 'not-configured'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `üöÄ Deployed to production: ${{ steps.deploy.outputs.deployment-url }}`
            })

  # Job 5: Database migrations (if needed)
  migrate-database:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: deploy
    if: false  # Enable if you need automatic migrations
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run migrations
        run: pnpm prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}

  # Job 6: Post-deployment verification
  post-deploy:
    name: Post-deployment Checks
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Health check
        run: |
          echo "Running post-deployment health checks..."
          # Add your health check endpoint
          # curl -f https://your-production-url.com/api/health || exit 1

      - name: Notify team
        run: |
          echo "‚úÖ Deployment completed successfully"
          echo "üì¶ Version: ${{ github.sha }}"
          echo "üë§ Deployed by: ${{ github.actor }}"

      - name: Create deployment summary
        run: |
          echo "# Deployment Summary üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Deployment successful!" >> $GITHUB_STEP_SUMMARY

  # Job 7: Rollback (manual trigger)
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Notify rollback needed
        run: |
          echo "‚ùå Deployment failed - rollback may be needed"
          echo "Check the logs and consider manual rollback if necessary"
